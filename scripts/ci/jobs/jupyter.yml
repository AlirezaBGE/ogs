# Built for Sandy Bridge (envinf1) and newer
build jupyter:
  stage: build
  tags: [envinf23, shell]
  needs: [meta]
  extends:
    - .container-maker-setup
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - >
      if [[ "$CI_COMMIT_BRANCH" == "master" ]] ; then
        export DOCKER_TAG_JUPYTER="$CI_REGISTRY/ogs/$CI_PROJECT_NAME/ogs-serial-jupyter:latest"
        export DOCKER_TAG_JUPYTER_PETSC="$CI_REGISTRY/ogs/$CI_PROJECT_NAME/ogs-petsc-jupyter:latest"
        export ON_MASTER_ARGS="--upload -C"
      else
        export DOCKER_TAG_JUPYTER="ci-$CI_PROJECT_NAME-$CI_COMMIT_BRANCH-serial-jupyter:latest"
        export DOCKER_TAG_JUPYTER_PETSC="ci-$CI_PROJECT_NAME-$CI_COMMIT_BRANCH-petsc-jupyter:latest"
      fi
    ### Jupyter container ###
    # Serial image
    - >
      poetry run ogscm compiler.py ogs.py ogs_jupyter.py -B -R --ogs ../..
      --build_args ' --progress=plain' --cvode --ccache --cpmcache --mfront --cpu-target $CPU_TARGET
      --cmake_args ' -DOGS_CPU_ARCHITECTURE=OFF -DOGS_BUILD_TESTING=OFF'
      --runtime_base_image 'registry.opengeosys.org/ogs/ogs/jupyter/base-notebook:22.04_3.10'
      --tag $DOCKER_TAG_JUPYTER
      $ON_MASTER_ARGS
    # PETSc image
    - >
      poetry run ogscm compiler.py mpi.py ogs.py ogs_jupyter.py -B -R --ogs ../..
      --build_args ' --progress=plain' --cvode --ccache --cpmcache --mfront --cpu-target $CPU_TARGET
      --cmake_args ' -DOGS_CPU_ARCHITECTURE=OFF -DOGS_BUILD_TESTING=OFF'
      --runtime_base_image 'registry.opengeosys.org/ogs/ogs/jupyter/base-notebook:22.04_3.10'
      --mpi_no_entrypoint
      --tag $DOCKER_TAG_JUPYTER_PETSC
      $ON_MASTER_ARGS
  artifacts:
    name: container
    when: always
    paths:
      - web/content/docs/benchmarks
      - Tests/Data/_out/**/*.html
      - Tests/Data/_out/**/out.txt

test notebooks via wheel:
  stage: build
  tags: [envinf23, shell]
  script:
    - cd Tests/Data
    - python -m venv --upgrade-deps .venv
    - source .venv/bin/activate
    - pip install -r requirements.txt
    - pip install -r requirements-dev.txt
    - pip install -r requirements-ogs.txt
    - find . -type f -iname '*.ipynb' | grep -vP '\.ipynb_checkpoints|\.ci-skip.ipynb$|_out|.venv' | PYVISTA_HEADLESS=1 xargs python Notebooks/testrunner.py --out _out
  cache:
    paths:
      - Tests/Data/.venv
  artifacts:
    when: always
    paths:
      - Tests/Data/_out/**/*.html
      - Tests/Data/_out/**/out.txt
